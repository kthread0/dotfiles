# ==============================================================================
# OPTIMIZED SYSCTL CONFIGURATION - 32GB RAM SYSTEM
# Target: Music Production (Sub-3ms latency) + Gaming (144Hz+)
# Hardware: 32GB RAM, 6C/12T AMD CPU
# Security: Hardened (LLVM/Clang conventions)
# Date: 2025-11-10
# User: kthread0
# ==============================================================================

# ------------------------------------------------------------------------------
# KERNEL: Scheduler & Realtime
# ------------------------------------------------------------------------------

# Unlimited realtime scheduling (CRITICAL for audio)
# Reference: Documentation/admin-guide/pm/cpuidle.rst
kernel.sched_rt_runtime_us = -1

# RCU subsystem tuning
# Reference: Documentation/RCU/
kernel.sched_rt_runtime_us = -1
kernel.timer_migration = 1                   # Allow timer migration to housekeeping CPUs

# Process accounting: check every 5s if >1% CPU, log if >10% CPU
kernel.acct = 5 1 10

# Message queue limits (adequate for most workloads)
kernel.msgmax = 32768
kernel.msgmnb = 32768
kernel.msgmni = 32768

# ------------------------------------------------------------------------------
# KERNEL: Security Hardening
# Reference: Documentation/admin-guide/kernel-parameters.txt
# ------------------------------------------------------------------------------

# Restrict kernel information exposure (defense in depth)
kernel.dmesg_restrict = 1                   # Restrict dmesg to CAP_SYSLOG
kernel.kptr_restrict = 2                    # Hide kernel pointers (all users)
kernel.kexec_load_disabled = 1              # Disable kexec (prevent kernel replacement)

# Printk level: only ERR and higher
# Format: console_loglevel default_message_loglevel minimum_console_loglevel default_console_loglevel
kernel.printk = 3 3 3 3

# Magic SysRq key: disabled for production
# Reference: Documentation/admin-guide/sysrq.rst
kernel.sysrq = 0                            # Fully disabled
# kernel.sysrq = 244                        # Alternative: only TERM(128)+KILL(64)+BOOT(32)+NICE(16)+SYNC(4)

# Restrict performance monitoring
kernel.perf_event_paranoid = 3              # Require CAP_PERFMON for all events

# BPF hardening
kernel.unprivileged_bpf_disabled = 1        # Only root can use BPF
kernel.bpf_stats_enabled = 0                # Disable BPF statistics (reduce overhead)

# Core dump restrictions
kernel.core_uses_pid = 1                    # Append PID to core dump filenames
kernel.core_pattern = |/bin/false           # Disable core dumps (or set to /var/crash/core.%e.%p.%h.%t)

# Yama LSM ptrace restrictions
# Reference: Documentation/admin-guide/LSM/Yama.rst
kernel.yama.ptrace_scope = 1                # Restricted ptrace (only descendants)

# ------------------------------------------------------------------------------
# MEMORY: Virtual Memory Subsystem - 32GB Optimized
# Reference: Documentation/admin-guide/sysctl/vm.rst
# ------------------------------------------------------------------------------

# ASLR entropy for x86_64 (maximum without breaking compatibility)
vm.mmap_rnd_bits = 32                       # 32 bits for 64-bit (4GB of entropy)
vm.mmap_rnd_compat_bits = 16                # 16 bits for 32-bit compat

# Dirty page writeback tuning (32GB system)
# With 32GB RAM:
# - dirty_ratio=10 = 3.2GB before blocking writes
# - dirty_background_ratio=5 = 1.6GB triggers background writeback
vm.dirty_ratio = 10                         # Block writes at 3.2GB dirty pages
vm.dirty_background_ratio = 5               # Start writeback at 1.6GB dirty pages
vm.dirty_expire_centisecs = 1000            # Dirty pages expire after 10s
vm.dirty_writeback_centisecs = 500          # Check for expired dirty pages every 5s

# Cache pressure: balance between reclaiming dentries/inodes vs page cache
# Lower = prefer keeping dentries/inodes (better for DAW sample libraries)
# Default = 100, lower = less aggressive
vm.vfs_cache_pressure = 50                  # Prefer keeping dentry/inode cache

# Swap behavior (32GB system can be aggressive about not swapping)
vm.swappiness = 5                           # Very low swapping preference (was 10)
vm.page-cluster = 0                         # Disable swap readahead (assumes SSD swap or no swap)

# Memory reclaim and watermark tuning (32GB system)
# With 32GB, we can afford to keep more memory free for sudden allocations
# min_free_kbytes: keep this much memory free (recommended: sqrt(RAM_KB) * 4)
# For 32GB: sqrt(33554432) * 4 ≈ 23,170 KB, round to 262,144 KB (256 MB = 0.8% of RAM)
vm.min_free_kbytes = 262144                 # Keep 256MB free (0.8% of 32GB)

# Watermark scale factor: controls aggressiveness of kswapd
# Lower = less aggressive reclaim (better for latency)
# Formula: (min_free_kbytes * watermark_scale_factor / 10000) = extra headroom
# 125 = add 12.5% extra headroom = 256MB * 0.125 = 32MB additional
vm.watermark_scale_factor = 125             # Moderate reclaim aggressiveness

# Watermark boost: temporarily boost watermarks after allocation
# 0 = disabled (better for latency-sensitive workloads)
vm.watermark_boost_factor = 0               # Disable watermark boosting

# Memory overcommit strategy (32GB = plenty of RAM)
# 0 = heuristic (default), 1 = always allow, 2 = strict (don't overcommit)
vm.overcommit_memory = 0                    # Heuristic overcommit (safe default)
vm.overcommit_ratio = 50                    # Allow up to 50% RAM + swap overcommit

# Transparent Hugepage defragmentation
# 0 = never, 1 = madvise only, 2 = always
# Should match kernel cmdline: transparent_hugepage=madvise
vm.defrag_mode = 1                          # Only defrag when requested via madvise

# Memory compaction (reduce fragmentation for large allocations)
# compaction_proactiveness: 0-100, higher = more aggressive
# With 32GB, low proactiveness is fine (compaction adds latency)
vm.compaction_proactiveness = 20            # Low proactive compaction
vm.compact_unevictable_allowed = 1          # Allow compacting unevictable pages

# NUMA zone reclaim (disable unless you have NUMA system)
# 0 = prefer allocating from remote NUMA nodes over reclaim
vm.zone_reclaim_mode = 0                    # Disable NUMA zone reclaim

# Memory statistics collection interval
# Reduce frequency to lower overhead (default = 1s)
vm.stat_interval = 60                       # Update stats every 60s

# Working set protection (protect against one-time big scans)
vm.workingset_protection = 1                # Protect working set from scans

# Maximum memory map areas (very high for games like Star Citizen)
# Default = 65530, max = 2147483642
vm.max_map_count = 2147483642               # Maximum possible (some games need this)

# Hugetlb optimization (if using hugepages)
# Reference: Documentation/admin-guide/mm/hugetlbpage.rst
vm.hugetlb_optimize_vmemmap = 1             # Optimize vmemmap for hugetlb

# OOM killer behavior
vm.oom_kill_allocating_task = 0             # Kill task using most memory, not triggering task
vm.panic_on_oom = 0                         # Don't panic, let OOM killer handle it
vm.oom_dump_tasks = 1                       # Dump task list on OOM (debugging)

# Laptop mode (disable for desktop)
vm.laptop_mode = 0                          # Disable laptop mode

# Extfrag threshold (control external fragmentation)
# Range: 0-1000, higher = more aggressive compaction
vm.extfrag_threshold = 500                  # Moderate fragmentation threshold

# ------------------------------------------------------------------------------
# FILESYSTEM
# Reference: Documentation/admin-guide/sysctl/fs.rst
# ------------------------------------------------------------------------------

# Dentry cache optimization
fs.dentry-negative = 1                      # Cache negative dentries (faster lookups)

# Security: Protect against race conditions and symlink attacks
# Reference: Documentation/admin-guide/sysctl/fs.rst
fs.protected_fifos = 2                      # Only owner can open FIFOs in sticky dirs
fs.protected_hardlinks = 1                  # Restrict hardlink creation
fs.protected_regular = 2                    # Only owner can open regular files in sticky dirs
fs.protected_symlinks = 1                   # Restrict symlink following in sticky dirs

# Inotify limits (CRITICAL for DAWs with large sample libraries)
# Default max_user_watches = 8192 (too low for modern DAWs)
# Each watch consumes ~1KB RAM: 524288 watches = ~512MB RAM (acceptable for 32GB system)
fs.inotify.max_user_watches = 524288        # 64x default (supports large libraries)
fs.inotify.max_user_instances = 512         # Max inotify instances per user
fs.inotify.max_queued_events = 32768        # Max queued events per instance

# File descriptor limits
fs.file-max = 2097152                       # System-wide file descriptor limit
fs.nr_open = 1048576                        # Per-process file descriptor limit

# AIO limits (for databases, high-performance I/O)
fs.aio-max-nr = 1048576                     # Max concurrent AIO requests

# Pipe limits
fs.pipe-max-size = 1048576                  # Max pipe buffer size (1MB)
fs.pipe-user-pages-soft = 16384             # Soft limit on pipe buffer pages per user
fs.pipe-user-pages-hard = 32768             # Hard limit on pipe buffer pages per user

# SUID core dump security
fs.suid_dumpable = 0                        # Don't create core dumps for SUID programs

# Leases (file locking)
fs.leases-enable = 1                        # Enable file leases

# Directory notification
fs.dir-notify-enable = 1                    # Enable dnotify (legacy, inotify preferred)

# ------------------------------------------------------------------------------
# NETWORK: Core Buffer Configuration (32GB System)
# Reference: Documentation/networking/ip-sysctl.rst
# ------------------------------------------------------------------------------

# Socket buffer sizes (aggressive for 32GB system)
# With 32GB RAM, we can afford generous network buffers
# Recommendation: 16-32MB max for high-throughput workloads
net.core.rmem_default = 16777216            # 16MB default receive buffer
net.core.rmem_max = 33554432                # 32MB max receive buffer (2x for 32GB system)
net.core.wmem_default = 16777216            # 16MB default send buffer  
net.core.wmem_max = 33554432                # 32MB max send buffer (2x for 32GB system)
net.core.optmem_max = 65536                 # Max ancillary buffer size

# Backlog queues (tuned for low latency + high throughput)
net.core.netdev_max_backlog = 32768         # Packet backlog queue (before kernel processing)
net.core.netdev_budget = 600                # Max packets per NAPI poll
net.core.netdev_budget_usecs = 8000         # Max time per NAPI poll (8ms)

# Listen backlog (connection queue)
net.core.somaxconn = 4096                   # Max listen() backlog (was 8192, balanced)

# Queueing discipline: CAKE (excellent for gaming + streaming)
# Reference: https://www.bufferbloat.net/projects/codel/wiki/Cake/
net.core.default_qdisc = cake

# BPF JIT compiler
net.core.bpf_jit_enable = 1                 # Enable JIT (better performance)
net.core.bpf_jit_harden = 2                 # Harden for all users (security)
net.core.bpf_jit_kallsyms = 0               # Don't expose JIT addresses (security)

# Busy polling for ultra-low latency (optional - increases CPU usage)
# Uncomment for competitive gaming with <1ms network latency requirement
net.core.busy_poll = 50                   # Busy poll for 50μs
net.core.busy_read = 50                   # Busy read for 50μs

# Flow steering (distribute packets across CPUs)
net.core.rps_sock_flow_entries = 32768      # Global flow table size
net.core.netdev_max_backlog = 32768         # Must match backlog

# ------------------------------------------------------------------------------
# NETWORK: IPv4 TCP/UDP Configuration
# Reference: Documentation/networking/ip-sysctl.rst
# ------------------------------------------------------------------------------

# TCP buffer auto-tuning (32GB system = generous buffers)
# Format: min default max
# With 32GB RAM, allow up to 32MB per socket
net.ipv4.tcp_rmem = 4096 131072 33554432    # 4KB min, 128KB default, 32MB max receive
net.ipv4.tcp_wmem = 4096 131072 33554432    # 4KB min, 128KB default, 32MB max send

# UDP buffer sizes (less critical than TCP)
net.ipv4.udp_rmem_min = 8192                # 8KB min UDP receive buffer
net.ipv4.udp_wmem_min = 8192                # 8KB min UDP send buffer

# TCP memory limits (32GB system)
# Format: min pressure max (in pages, 4KB per page)
# With 32GB RAM, allocate ~10% for TCP buffers = 3.2GB = 838,860 pages
# min = 10% of max, pressure = 75% of max, max = 838,860
net.ipv4.tcp_mem = 83886 629145 838860      # TCP memory allocation limits (pages)

# TCP performance tuning
net.ipv4.tcp_fastopen = 3                   # Enable TFO for client(1) + server(2)
net.ipv4.tcp_slow_start_after_idle = 0      # Don't slow start after idle (gaming)
net.ipv4.tcp_mtu_probing = 1                # Enable Path MTU Discovery
net.ipv4.tcp_timestamps = 1                 # Enable timestamps (required for BBR, PAWS)
net.ipv4.tcp_sack = 1                       # Selective ACK (better loss recovery)
net.ipv4.tcp_fack = 1                       # Forward ACK (better loss detection)
net.ipv4.tcp_dsack = 1                      # Duplicate SACK (detect reordering)
net.ipv4.tcp_ecn = 1                        # Explicit Congestion Notification (reduce bufferbloat)
net.ipv4.tcp_early_retrans = 4              # Early retransmit (reduce tail latency)
net.ipv4.tcp_rfc1337 = 1                    # Protect against TIME-WAIT assassination
net.ipv4.tcp_window_scaling = 1             # Enable window scaling (high bandwidth)

# Congestion control: BBR (best for gaming + streaming)
# Reference: https://queue.acm.org/detail.cfm?id=3022184
net.ipv4.tcp_congestion_control = bbr
net.ipv4.tcp_notsent_lowat = 16384          # Send buffer low watermark (reduce bufferbloat)

# Connection handling
net.ipv4.tcp_max_syn_backlog = 32768        # Max SYN backlog (DDoS protection)
net.ipv4.tcp_max_tw_buckets = 2000000       # Max TIME-WAIT sockets (high-traffic servers)
net.ipv4.tcp_fin_timeout = 10               # Fast FIN timeout (close dead connections)
net.ipv4.tcp_syncookies = 1                 # SYN flood protection

# TCP keepalive (detect dead connections faster)
net.ipv4.tcp_keepalive_time = 60            # Start probing after 60s idle
net.ipv4.tcp_keepalive_intvl = 10           # Probe every 10s
net.ipv4.tcp_keepalive_probes = 6           # 6 failed probes = dead (60s total)

# Local port range (ephemeral ports for outbound connections)
net.ipv4.ip_local_port_range = 16384 65535  # 49,152 available ports

# ICMP rate limiting (prevent DoS while allowing legitimate use)
net.ipv4.icmp_ratelimit = 100               # 100ms between ICMP messages
net.ipv4.icmp_ratemask = 6168               # Rate limit: dest_unreach(3), time_exceeded(11), param_problem(12)

# TCP reordering tolerance
net.ipv4.tcp_reordering = 3                 # Default reordering tolerance (3 duplicate ACKs)

# TCP retries (faster failure detection)
net.ipv4.tcp_syn_retries = 3                # SYN retries (was 6, faster timeout)
net.ipv4.tcp_synack_retries = 3             # SYN-ACK retries (was 5, faster timeout)
net.ipv4.tcp_orphan_retries = 2             # Retries for orphaned sockets

# TCP memory pressure behavior
net.ipv4.tcp_moderate_rcvbuf = 1            # Auto-tune receive buffer
net.ipv4.tcp_no_metrics_save = 1            # Don't cache metrics (prefer fresh measurements)

# MTU discovery
net.ipv4.tcp_base_mss = 1024                # Base MSS for Path MTU Discovery
net.ipv4.tcp_mtu_probe_floor = 48           # Min MTU probe size

# ------------------------------------------------------------------------------
# NETWORK: IPv4 Security Hardening
# Reference: Documentation/networking/ip-sysctl.rst
# ------------------------------------------------------------------------------

# Security: Prevent source routing attacks
net.ipv4.conf.all.accept_source_route = 0
net.ipv4.conf.default.accept_source_route = 0

# Security: Enable reverse path filtering (prevent IP spoofing)
# 1 = strict mode, 2 = loose mode
net.ipv4.conf.all.rp_filter = 1
net.ipv4.conf.default.rp_filter = 1

# Security: Ignore ICMP redirects (prevent MITM)
net.ipv4.conf.all.accept_redirects = 0
net.ipv4.conf.default.accept_redirects = 0
net.ipv4.conf.all.secure_redirects = 0
net.ipv4.conf.default.secure_redirects = 0

# Security: Don't send ICMP redirects (we're not a router)
net.ipv4.conf.all.send_redirects = 0
net.ipv4.conf.default.send_redirects = 0

# Security: Ignore broadcast pings (smurf attack prevention)
net.ipv4.icmp_echo_ignore_broadcasts = 1

# Security: Ignore bogus ICMP error responses
net.ipv4.icmp_ignore_bogus_error_responses = 1

# Security: Log martian packets (spoofed/malformed packets)
# Can be noisy, disable in production if logs fill up
net.ipv4.conf.all.log_martians = 0
net.ipv4.conf.default.log_martians = 0

# Security: Enable bad error message protection
net.ipv4.icmp_errors_use_inbound_ifaddr = 0

# Forwarding (disable unless this is a router)
net.ipv4.ip_forward = 0
net.ipv4.conf.all.forwarding = 0
net.ipv4.conf.default.forwarding = 0

# ------------------------------------------------------------------------------
# NETWORK: IPv6 Configuration
# Reference: Documentation/networking/ip-sysctl.rst
# Reference: RFC 4861 (Neighbor Discovery for IPv6)
# ------------------------------------------------------------------------------

# IPv6 fragment reassembly buffers
net.ipv6.ip6frag_high_thresh = 4194304      # 4MB fragment reassembly buffer
net.ipv6.ip6frag_low_thresh = 3145728       # 3MB low threshold

# IPv6 Router Advertisements (CRITICAL for systemd-resolved)
# accept_ra values:
#   0 = disabled (breaks SLAAC and RDNSS)
#   1 = enabled if forwarding is disabled (correct for client)
#   2 = always enabled (even if forwarding is on)
net.ipv6.conf.all.accept_ra = 1             # Accept RA (required for DNS/SLAAC)
net.ipv6.conf.default.accept_ra = 1         # Accept RA on new interfaces

# IPv6 Router Advertisement components
net.ipv6.conf.all.accept_ra_defrtr = 1      # Accept default router in RA
net.ipv6.conf.default.accept_ra_defrtr = 1
net.ipv6.conf.all.accept_ra_pinfo = 1       # Accept prefix info in RA (for SLAAC)
net.ipv6.conf.default.accept_ra_pinfo = 1
net.ipv6.conf.all.accept_ra_rtr_pref = 1    # Accept router preference in RA
net.ipv6.conf.default.accept_ra_rtr_pref = 1

# IPv6 Stateless Address Autoconfiguration (SLAAC)
# Required for automatic IPv6 address assignment
net.ipv6.conf.all.autoconf = 1              # Enable SLAAC
net.ipv6.conf.default.autoconf = 1          # Enable SLAAC on new interfaces

# IPv6 Security (safe to harden)
net.ipv6.conf.all.accept_redirects = 0      # Ignore ICMP redirects (security)
net.ipv6.conf.default.accept_redirects = 0
net.ipv6.conf.all.accept_source_route = 0   # No source routing (security)
net.ipv6.conf.default.accept_source_route = 0

# IPv6 Forwarding (disable - we're not a router)
net.ipv6.conf.all.forwarding = 0            # Not a router
net.ipv6.conf.default.forwarding = 0

# IPv6 MTU
net.ipv6.conf.all.mtu = 1500                # Standard Ethernet MTU
net.ipv6.conf.default.mtu = 1500

# IPv6 temporary addresses (privacy extensions)
# Reference: RFC 4941 (Privacy Extensions for SLAAC)
# 0 = disabled, 1 = enabled but prefer public, 2 = enabled and prefer temporary
net.ipv6.conf.all.use_tempaddr = 2          # Prefer temporary addresses (privacy)
net.ipv6.conf.default.use_tempaddr = 2

# IPv6 duplicate address detection (DAD)
# Number of neighbor solicitations to send (1-3 typical)
net.ipv6.conf.all.dad_transmits = 1         # Fast DAD (1 probe)
net.ipv6.conf.default.dad_transmits = 1

# IPv6 router solicitation
net.ipv6.conf.all.router_solicitations = 3  # Send 3 RS messages
net.ipv6.conf.default.router_solicitations = 3
net.ipv6.conf.all.router_solicitation_delay = 1     # Delay 1s before first RS
net.ipv6.conf.default.router_solicitation_delay = 1
net.ipv6.conf.all.router_solicitation_interval = 4  # 4s between RS messages
net.ipv6.conf.default.router_solicitation_interval = 4

# IPv6 neighbor reachability
net.ipv6.neigh.default.gc_thresh1 = 128     # Min entries before GC
net.ipv6.neigh.default.gc_thresh2 = 512     # Threshold for aggressive GC
net.ipv6.neigh.default.gc_thresh3 = 1024    # Max entries (hard limit)

# IPv6 route table
net.ipv6.route.max_size = 16384             # Max IPv6 routes (reasonable for client)

# ------------------------------------------------------------------------------
# DEVICE SECURITY
# Reference: Documentation/admin-guide/devices.txt
# ------------------------------------------------------------------------------

# Prevent auto-loading TTY line disciplines (CVE-2019-18786)
dev.tty.ldisc_autoload = 0
